{% extends 'base2.html.twig' %}
{% block styles %}
    <link href="{{asset('plugins/select2.4/dist/css/select2.min.css')}}" rel="stylesheet"/>
    <link href="{{asset('plugins/dtables/datatables.min.css')}}" rel="stylesheet">
    <style>
        div.dataTables_wrapper div.dataTables_paginate ul.pagination,
        div.dataTables_wrapper div.dataTables_info {
            white-space: nowrap;
            font-size: 13px !important;
            display: none;
        }
        .was-validated .custom-select:invalid + .select2 .select2-selection {
            border-color: #dc3545 !important;
        }
        .was-validated .custom-select:valid + .select2 .select2-selection {
            border: 1px solid #d1d3e2 !important;
        }

        .border-box {
            background: #FAFAFA;

            padding: 10px 25px;
        }
        .border-box .form-control, .border-box .select2-container .select2-selection--single{
            border: 1px solid #82B5E9;
        }
        
        #box-table {
            height: 500px;
            border: 1px solid #990000;
        }
        .was-validated .form-control:valid,
        .form-control.is-valid {
            border: 1px solid #d1d3e2 !important;
        }
        *:focus {
            outline: 0;
        }
        .datetimepicker-input {
            height: 35px;
        }
        .input-group-text {
            border-radius: 0;
        }
        div.dataTables_wrapper div.dataTables_filter {
            display: none;
        }
        .bg-grey i {
            color: #DDD !important;
        }
        
        .bg-info-table {
            background: #F8D8D3;
            border: none !important;
            color: #000 !important;
        }
        .bg-grey {
            border-bottom: 1px solid #F8D8D3;
        }
        .list-group-item {
            cursor: pointer;
        }
        form label {
            margin-bottom: 0;
            font-weight: normal;
            font-size: 13px;
            color: #333 !important;
        }
        .modal-body form {
            padding: 5px 30px;
        }
        #accordion-1 {
            margin-top: 0px;
        }
        #myInputTextField{
            margin-bottom: 0px;
        }
        .form-control,
        .select2-container--default .select2-selection--multiple,
        .select2-container .select2-selection--single {
            border-radius: 2px !important;
            margin-bottom: 10px;
            font-size: 13px;
            border: 1px solid #82B5E9;
        }
        table th {
            cursor: pointer !important;
            white-space: nowrap;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #777777 !important;
        }
        .select2-container .select2-selection--single {
            border-radius: 2px;
            height: 35px;
            padding-top: 3px;
            border: 1px solid #82B5E9;
            font-size: 13px;
        }
        .select2-results__option {
            font-size: 13px;
            color: #999999;
        }
        label {
            margin-bottom: 0;
        }
        #accordion .card .card-header, .accordions .card .card-header {
            padding: 7px 10px;
            border-radius: 0 !important;
        }
        table.dataTable th {
            color: #418FDE  !important;
            font-weight: normal;
            background: #fff;
            border-bottom: 1px solid #999;
        }
        .table th,
        .table td {
            font-size: 13px;
        }
        table.dataTable td,
        table.dataTable th {
            font-size: 13px;
            cursor: pointer;
           
            /* white-space: nowrap;*/
        }
        .table td{
            padding: 5px 5px;
        }
        .whoclass {
            background: #E6E6E6;
        }
        .whatclass {
            background: #D4E5F7;
        }
        .whereclass {
            background: #F8D8D3;
        }
        .whomclass {
            background: #D6F5F3;
        }
        .whenclass {
            background: #E4D8F3;
        }
        table tr td .btn {
            padding: 1px 9px !important;
            font-size: 11px;
        }

        .card-header h5 {
            padding-top: 7px;
        }
        .card-header {
            background: #EBF0F4;
        }

        tr.awesome {
            color: red;
        }
        .second-card-header {
            background: #fff !important;
            border: 1px solid #fff !important;
            padding: 0 !important;
        }
        .card-body {
            padding: 15px 15px 15px 15px !important;
        }
        .card-body .card-body {
            padding: 0 !important;
        }

        .bg-grey .card-body {
            padding: 7px 15px 10px !important;
        }
        .card {
            border-radius: 0;
            border: none !important;
        }
        #whom_location {
            color: #418FDE;
        }
        .legend-form {
            background:  #D4E5F7;
            font-weight: normal;
            color: #333333;
            padding: 5px 5px 3px;
            font-size: 16px;
            margin-bottom: 0px;
        }
        .list-group-item {
            cursor: pointer;
            padding: 8px;
            font-size: 13px;
        }
        .list-group-item .badge {
            font-size: 13px;
        }
        .btn-icon-split {
            border-radius: 0 !important;
        }
        #box-main-org {
            padding-top: 22px;
        }

  
        .list-list {
            color: #418FDE;
            font-size: 13px !important;
            padding: 2px 5px;
            cursor: pointer;
            background: #fff;
            border-bottom: 1px dotted #418FDE;
        }
        .span-total-org {
            color: #CD3A1F;
        }
        .list-org {
            background: #fff !important;
            border-bottom: 1px dotted #dddddd !important;
            color: #777 !important;
        }
        .list-org-active {}
        .list-org-active {
            background: #eeeeee !important;
            color: #418FDE !important;
            border-bottom: none !important;
        }
        .list-org-active .span-total-org {
            color: #000000 !important;
        }
        #list-filter-org {
            height: 600px;
            overflow: auto;
        }
        .filtertd{
            height: 25px;
            width: 100%;
            cursor: pointer;

        }

.form-control-table {
    display: block;
    width: 100%;
    height: 25px;
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    font-weight: 400;
    line-height: 1.5;
    color: #6e707e;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid #D4E5F7;
}

#dropdown1, #dropdown1 > option, #dropdown2, #dropdown3, #dropdown4{
    cursor: pointer;
}
.btnsmall{
    padding: 2px 10px !important;
}

#filtros .select2-results__option {
    font-size: 13px;
    padding: 3px;
}

#filtros .select2-container .select2-selection--single{
    height: 28px;
    padding-top: 0px;
}
#filtros .select2-container--default .select2-search--dropdown .select2-search__field {
    height: 25px !important;
    font-size: 13px;
}
#filtros label{
    font-size: 13px;
    color: #333;
}
#accordion0 .card-header{
    padding: 4px 15px;
    border-radius: 0px;
}
#accordion0 .card-header h5{
    padding-top: 0px;
}

#accordion0 .btn-link{
    color: #000;
    cursor: pointer;
}
.pform{
    margin-bottom: 0px;
    margin-top: 10px;
}
.project-tab {
    padding: 10%;
    margin-top: -8%;
}
.project-tab #tabs{
    background: #007b5e;
    color: #eee;
}
.project-tab #tabs h6.section-title{
    color: #eee;
}
.project-tab #tabs .nav-tabs .nav-item.show .nav-link, .nav-tabs .nav-link.active {
    color: #0062cc;
    background-color: transparent;
    border-color: transparent transparent #f3f3f3;
    border-bottom: 3px solid !important;
    font-size: 16px;
    font-weight: bold;
}
.project-tab .nav-link {
    border: 1px solid transparent;
    border-top-left-radius: .25rem;
    border-top-right-radius: .25rem;
    color: #0062cc;
    font-size: 16px;
    font-weight: 600;
}
.project-tab .nav-link:hover {
    border: none;
}
.project-tab thead{
    background: #f3f3f3;
    color: #333;
}
.project-tab a{
    text-decoration: none;
    color: #333;
    font-weight: 600;
}

.trdepartamento td{
    color: #000000 !important;
    font-weight: bold !important;
}
.trdepartamento{
    border: none !important;
    background: #f5f5f5;
}
.tdmunicipio{
    padding-left: 10px !important;
}
.hide{
    display: none;
}

.tdfocus:hover{ 
position: relative;
}
.tdfocus{ 
    background: #EB5C6D !important;
    position: relative;
    -webkit-box-shadow:inset 0px 0px 0px 3px #ffffff;
    -moz-box-shadow:inset 0px 0px 0px 3px #ffffff;
    box-shadow:inset 0px 0px 0px 3px #ffffff;
    color: #ffffff;
    text-align: center;
    font-size: 13px<
}
table {
    width: 100%;
    border-spacing: 0;
    color: #212121;
    text-align: left;
    overflow: hidden;
}
table th img{
    z-index: 500;
    position: relative;
}
table th{
    align: center;
    font-size: 12px;
}
.tdselection{
    cursor: pointer;
    border: 1px solid #ddd !important;
}
.tdselection:hover{
    cursor: pointer;
}
table>tbody>tr>td {
    padding: 10px;
    font-size: 13px;
    position: relative;
    color: #777777;
    cursor: pointer;

}
.ptext{
    font-size: 12px;
    color: #888888;
}
table>tbody>tr>td.tdselection:hover{
    background-color: #EB5C6D !important;
    z-index: 15;
    cursor: pointer;
}
table>tbody>tr:hover {
    padding: 20px;
    background-color: #ffa !important;
}
.tab-content{
    padding-top: 10px;
}
#nav-tab .nav-link {
    padding: 10px 25px 10px 5px;
}
td:hover::after {
    content: "";
    position: relative;
    background-color: #ffa;
    left: 0;
    top: -5000px;
    height: 10000px;
    width: 100%;
    z-index: 5;
}
#accordion .card .card-header{
    font-size: 15px;
}

.card-act-active{
    background: #595959;
    color: #fff;
}
.card-act-active a{
    color: #fff;
}
.item-card{
    padding: 8px 10px;
    background: #eee;
    margin-bottom: 10px;
}
.item-card .text{
    color: #025995;
}
.item-card .number{
    color: #EB5C6D;
}
.where-admin2{
    padding-left: 20px;
}
.where-admin1{
    padding: 5px;
    color: #ffffff;
    background: #026CB6;
}
.selected-admin2{
    color:  #026CB6;
    background: #eee;
}
.savingact{
    color: #1cc88a;
    display: none;
}
.tablesacts{
    padding-left: 10px;
}
</style>
{% endblock %}
{% block main %}
{% if project.id in app.user.projects %}
    <div class="row">
        <div class="col-md-12">
            <h1 class="float-left">{{project.nombre|title}}
            </h1>
           <!-- <a class="btn btn-success btn-icon-split float-right add-record" data-id="0" data-org="0" href="#" data-toggle="tooltip" title="Add activity or record to this project">
                <span class="icon">
                    <i class="fas fa-plus"></i>
                    Add {{ "actividad_id" in campos ? 'activity':'presence' }}
                </span>
            </a>
            -->
            <a class="btn btn-primary btn-icon-split float-right" href="{{path('admin_www_list')}}/{{project.id}}" data-toggle="tooltip" title="Go to the complete list">
                <span class="icon">
                    <i class="fas fa-bars"></i>
                    List
                </span>
            </a>
            <!--
            <a class="btn btn-primary btn-icon-split float-right" href="{{project.pbi}}" target="_blank" data-toggle="tooltip" title="Go to the interactive dashboard">
                <span class="icon">
                    <i class="fas fa-chart-pie"></i>
                    PBI
                </span>
            </a>
            -->
            {% if project.id == 2 %}
                <a class="btn btn-primary btn-icon-split float-right" href="{{path('tresw_dashboard_caribbean')}}/{{project.id}}/0" data-toggle="tooltip" title="Go to the project dashboard">
                    <span class="icon">
                        <i class="fas fa-chart-bar"></i>
                        Dashboard
                    </span>
                </a>                   
            {% else %}
                <a class="btn btn-primary btn-icon-split float-right" href="{{path('tresw_dashboard')}}/{{project.id}}/0" data-toggle="tooltip" title="Go to the project dashboard">
                <span class="icon">
                    <i class="fas fa-chart-bar"></i>
                    Dashboard
                </span>
            </a>
            {% endif %}


        </div>

    </div>
    <div class="clearfix"></div>
    <div class="row">
        <div class="col-xl-2 col-lg-2 col-md-3">
        <br>
        <div class="accordions">
            <div class="card">
                <div class="card-header" id="heading-1">
                    <h5 class="mb-0 float-left text-black text-md align-middle">
                        ORGANIZATIONS
                    </h5>
                    
                </div>
            </div>
            </div>
            {% set sw = 0 %}
            <div id="list-filter-org">
                {% for j,tipo in tipos %}
                    <div class="list-list">
                        {{ tipo.nombre|upper }}
                    </div>
                    {% for k,item in orgs if item.tipo == tipo.id %}
                        <div class="list-list list-org {{sw == 0 ? 'list-org-active':'' }}" id="list-org{{item.id}}" data-id="{{item.id}}" data-toggle="tooltip" data-placement="top" title="{{item.nombre}}">
                            <div class="span-total-org float-right"></div>
                            {{ item.code|upper }}
                        </div>
                        {% set sw = 1 %}
                    {% endfor %}
                {% endfor %}
            </div>
        </div>
        <div class="col-xl-10 col-lg-10 col-md-9">
            <div class="row">
                <div class="col-md-12" id="box-main">
                    <div class="row">
                        <div class="clearfix"></div><br>
                        <div class="col-md-12" id="box-main-org">
                        
                        <div class="alert alert-default" role="alert">
        <h4 class="alert-heading">Select your organization</h4>
        <p></p>
        <p class="mb-0">Please select an organization from the left list or add an activity for your organization.</p>
        <p></p>
        <hr>
        <p class="mb-0">If you have doubts please contact to cruz23@un.org or urriola@un.org</p>
    </div>
    
    </div>
                        
                </div>
            </div>

            <div class="clearfix"></div><br>
        </div>


    </div>
    <div class="clearfix"></div><br><br>
{% else %}
<div class="alert alert-warning" role="alert">
  <h4 class="alert-heading">Access Denied</h4>
  <p>Youd don't have rights to see this project. Please go back to the this or contact the administrator to request access.</p>
  <hr>
  <p class="mb-0">Project list. 
            <a class="btn btn-primary float-right" href="{{path('get_projects')}}">
                <span class="icon">
                    <i class="fas fa-bars"></i>
                    Projects
                </span>
            </a>
            <div class="clearfix"></div>
            </p>
</div>
{% endif %}
    <div aria-hidden="true" aria-labelledby="myExtraLargeModalLabel" class="modal fade bd-example-modal-xl" data-backdrop="static" data-keyboard="false" id="modal-form-record" role="dialog">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">EDIT / ADD {{ "actividad_id" in campos ? 'ACTIVITY':'PRESENCE' }}</h5>
                    <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="padding-left: 0px; padding-right: 0px;">
                    <form action="#" class="needs-validation" enctype="multipart/form-data" id="form-record" autocomplete="off" method="post" novalidate>
                        <i class="fa fa-spinner fa-spin fa-2x fa-fw"></i>
                        <span class="sr-only">Loading...</span>

                    </form>
                    <div class="w-100"></div><br>
                    <div class="col-md-12"></div>
                    <div class="w-100"></div><br>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-dismiss="modal" type="button">Close edition</button>
                </div>
            </div>
        </div>
    </div>

    <div aria-hidden="true" aria-labelledby="myExtraLargeModalLabel" class="modal fade bd-example-modal-xl" data-backdrop="static" data-keyboard="false" id="modal-where" role="dialog">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">EDIT / ADD WHERE</h5>
                    <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="padding-left: 0px; padding-right: 0px;">
                    <div class="col-md-12">
                        {% for item in departamentos %}
                            <div class="where-admin1 cursor-pointer" data-id="{{item.id}}">{{item.departamento}}</div>
                            <div class="where-admin2 cursor-pointer" data-id="{{item.id}}"></div>
                        {% endfor %}
                    <div>
                    <div class="w-100"></div><br>
                    <div class="col-md-12"></div>
                    <div class="w-100"></div><br>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-dismiss="modal" type="button">Close edition</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block javascripts %}


    <script src="{{asset('plugins/dtables/datatables.min.js')}}"></script>
    <script src="{{asset('plugins/select2.4/dist/js/select2.min.js')}}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.1/js/tempusdominus-bootstrap-4.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="{{asset('js/bootbox.min.js')}}"></script>


    <script>
        var paises = "";
        var orgselected;
        var idrecord;
        var camposa = [];
        {% for item in project.paises %}paises = paises + "{{ item }}" + "|";{% endfor %}paises = paises.substring(0, paises.length - 1);
        var campos = "";{% for item in campos %}campos = campos + "{{ item }}" + "|"; camposa.push('{{ item }}'); {% endfor %}campos = campos.substring(0, campos.length - 1)
        var t;
        var ventana_alto;
        var table;

        $(document).ready(function () {
            $(document).on('change', '.markallsectors', function () {
                if ($(this).is(':checked')) {
                    alert("mark all checked");
                }else{
                    bootbox.confirm({
                        title: "",
                        message: "<h3>Are you sure you want to delete the presence of this organization?</h3><br> If you delete this presence yo will delete all records asociated with this place (Activities, Beneficiaries, Resources, Etc)",
                        buttons: {
                            cancel: {
                                label: '<i class="fa fa-times"></i> Cancel'
                            },
                            confirm: {
                                label: '<i class="fa fa-check"></i> Delete'
                            }
                        },
                        callback: function (result) {
                            if (result) {
                                
                            }
                        }
                    });

                }
            });

            $(document).on('mouseenter', '.tdselection', function () {
                if ($(this).hasClass('thselection')){
                }else{
                    $(this).css({'background':'#EB5C6D'});
                }
            });
            $(document).on('mouseleave', '.tdselection', function () {
                if ($(this).hasClass('thselection')){
                }else{
                    $(this).css({'background':'inherit'});
                }
            
            });
            $(document).on('click', '.nav-acts', function () {
                var org = $(this).data('org');
                $.ajax({
                    type: "GET",
                    url: "{{path('get_list_activities')}}/{{project.id}}/{{project.lang}}/"+org+"/"+campos,
                    cache: false,
                    contentType: false,
                    processData: false,
                }).done(function (data) {
                    $("#box-activities").html(data.html);
     
                });
            });

            $(document).on('click', '.tdselection', function () {
                var selector = $(this);
                var org = $(this).data('org');
                var sector = $(this).data('sector');
                var id = $(this).data('id');
                var level = $(this).data('level');
                var project = "{{project.id}}";
                var item = $(this).data('item');
                if ($(this).hasClass('tdfocus')){

                    bootbox.confirm({
                        title: "",
                        message: "<h3>Are you sure you want to delete the presence of this organization?</h3><br> If you delete this presence yo will delete all records asociated with this place (Activities, Beneficiaries, Resources, Etc)",
                        buttons: {
                            cancel: {
                                label: '<i class="fa fa-times"></i> Cancel'
                            },
                            confirm: {
                                label: '<i class="fa fa-check"></i> Delete'
                            }
                        },
                        callback: function (result) {
                            if (result) {
                                $.ajax({
                                    data: 'org='+org+'&sector='+sector+'&id='+id+'&level='+level+'&project='+project,
                                    type: "POST",
                                    url: "{{path('where_delete')}}"
                                }).done(function (data) {
                                    selector.removeClass("tdfocus");  
                                    $(this).text('');    
                                    $("#modal-where").css({'overflow-y':'auto'});      
                                });
                            }
                        }
                    });
                }else{
                    selector.addClass("tdfocus");
                    $.ajax({
                        data: 'org='+org+'&sector='+sector+'&id='+id+'&level='+level+'&project='+project,
                        type: "POST",
                        url: "{{path('admin_donde_add')}}"
                    }).done(function (data) {
                        selector.data('item',data.id);
                        console.log(data.id);               
                    });
                }
            });



            {% if project.id in "sss" %}
            var id_main;
            if(parseInt("{{org}}") == 0){
                id_main = parseInt($("#list-filter-org .list-org-active").data('id'));
            }else{
                id_main = parseInt("{{org}}");
                $(".list-org").removeClass('list-org-active');
                $("#list-org{{org}}").addClass('list-org-active');
            }
            if(id_main){ 
                getOrgsActs(id_main);
            }
            {% endif %}
            $('[data-toggle="tooltip"]').tooltip();
            ventana_alto = $(window).height();
            ventana_alto = ventana_alto - 230;
            $("#list-filter-org").css({
                'height': ventana_alto + 'px'
            });

            $('#list_org').select2();
            $("#myMenu").find('.list-org').trigger('click');
            $("#search").on("keyup", function () {
                var value = $(this).val().toLowerCase();
                $("#myMenu li").filter(function () {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });

            });

            $(document).on('click', '.list-org', function () {
                var id_org = $(this).data('id');
                orgselected = id_org;
                $(".list-org").removeClass('list-org-active');
                $(this).addClass('list-org-active');
                getOrgsActs(id_org);
                /*var id_org = $(this).val();
                if (id_org == 0) {
                    $(".box-org").show();
                } else {
                    $(".box-org").hide();
                    $("#box-main-" + id_org).show();

                }*/
            });
            $(document).on('click', '.add-where', function () {
                $("#modal-where").modal("show");
                $(".where-admin2").each(function (index) {
                    var box = $(this);
                    var id = box.data('id');
                    $.ajax({
                        type: "GET",
                        url: "{{ path('ajax_admins') }}/admin2/" + id + "/{{project.lang}}" + "/" + orgselected + "/{{project.id}}",
                        cache: false,
                        contentType: false,
                        processData: false,
                        beforeSend: function (xhr) {}
                    }).done(function (data) {
                        box.html(data.html);
                    });
                });
            });
            $(document).on('click', '.admin2-id', function () {
                if($(this).hasClass('selected-admin2')){
                    $(this).removeClass('selected-admin2');
                }else{
                    $(this).addClass('selected-admin2');
                }
            });
            $(document).on('change', '#where_id_org', function () {
                var place = $(this);
                if(idrecord == 0){
                    $(".savingact").show();
                    $("#form-record").submit();
                }
     
            });
            $(document).on('change', '#where_id', function () {
                var place = $(this);
                var valor = place.val();
                var condicion = "tddepartamento"+valor;
                if(camposa.indexOf('municipio') >= 0){
                    condicion = "tdmunicipio"+valor;
                }
                if($("#"+condicion).length == 0){                    
                    var datawhere = $('#where_id').select2('data');
                    var result = datawhere[0].text.split(' - ');
                    var $tableBody = $('#table-chart').find("tbody"),
                    $trLast = $tableBody.find("tr:last"),
                    $trNew = $trLast.clone();
                    $trNew.find('td').each(function(){
                        var selector = $(this);
                        selector.removeClass('tdfocus');
                        selector.data('id',valor);
                        if(selector.hasClass('tddepartamento')){
                            selector.text(result[1].trim());
                        }
                        if(selector.hasClass('tdmunicipio')){
                            selector.text(result[2].trim());
                        }
                    });
                    $trLast.after($trNew);
                }else{
                    bootbox.alert("This location is already added to the presence table");
                }
            });
            
            
            // $(document).on('change', '#list-org', function () {
            $(".box-org").each(function (index) {
                var id_org = $(this).data('id');
                getOrgsActs(id_org);
            });
            $(document).on('change', '#sector_id', function (e) {
                //alert($(this).val());
                //$("#actividad_id").val("");
                Selectactivity($(this).val());
            });

            $(document).on('change', '#dropdown11', function (e) {
                var position = $(".sectortd").index();
                table.column( position ).search( $(this).val() ).draw();
            });


          
            $(document).on('change', '#dropdown22', function (e) {
                var position = $(".estadotd").index();
                table.column( position ).search( $(this).val() ).draw();
            });
            $(document).on('change', '#dropdown33', function (e) {
                var position = $(".departamentotd").index();
                table.column( position ).search( $(this).val() ).draw();
            });
            $(document).on('change', '#dropdown44', function (e) {
                var position = $(".municipiotd").index();
                table.column( position ).search( $(this).val() ).draw();
            });

                

            $(document).on('click', '.add-record', function (e) {
                var id = $(this).data('id');
                idrecord = id;
                $(".savingact").hide();
                var id_org = $(this).data('org');
                $("#form-record").html("<i class='fa fa-spinner fa-spin fa-3x fa-fw'></i><span class='sr-only'>Loading...</span>");
                $("#modal-form-record").modal('show');
                $.ajax({
                    type: "GET",
                    url: "{{ path('admin_www_new') }}/" + id + " /{{ project.id }}/" + "{{ project.lang }}/" + id_org + "/" + campos,
                    cache: false,
                    contentType: false,
                    processData: false,
                    beforeSend: function (xhr) {}
                }).done(function (data) {
                    $("#form-record").html(data.html);
                    $("#modal-form-record").modal('show');
                    selectLocationOrg(id_org);
                    SelectOrg();
                    $('.dates').datetimepicker({viewMode: 'days', format: 'DD/MM/YYYY'});
                    if (id != 0) {
                        Selectactivity($("#sector_id").val());
                    }else{
                        Selectactivity(0);
                    }
                    $('#recurso_id, #estado_id, #beneficiario_id, #subsector_id, #toficina_id, #tipo_id, #coverage_id, #unidad_id, #tactividad, #sector_id').select2();
                });

    
            });

        
            $("#form-record").submit(function (e) {
                event.preventDefault();
                if ($('#form-record')[0].checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                } else {
                    enviaForm();
                }
                $('#form-record').addClass('was-validated');

                return false;
            });
            $(document).on('click', '.delete-record', function () {
                var id = $(this).data('id');
                var idorg = $(this).data('org');
                bootbox.confirm({
                    title: "",
                    message: "Are you sure you want to delete thsi record ? This action will be irreversible.",
                    buttons: {
                        cancel: {
                            label: '<i class="fa fa-times"></i> Cancel'
                        },
                        confirm: {
                            label: '<i class="fa fa-check"></i> Delete'
                        }
                    },
                    callback: function (result) {
                        if (result) {
                            $(this).html('<i class="fa fa-spinner fa-spin" style=""></i>');
                            $.ajax({
                                url: "{{ path('record_delete') }}/" + id
                            }).done(function (data) {
                                $('#tr-record-' + id).hide('slow');
                                //getOrgsActs(idorg);
                                var numero = parseInt($("#list-org"+idorg+" .span-total-org").text())-1;
                                if(numero == 0){
                                    $("#list-org"+idorg).hide();
                                }else{
                                    $("#list-org"+idorg+" .span-total-org").html(numero);
                                }
                                
                                //getOrgsFilters(idorg);

                            });
                        }

                        // console.log('This was logged in the callback: ' + result);
                    }
                });
            });
        

        });



        function searchActivities(id_org) {
            $(".div-activities").each(function (i) {
                var id_div = $(this).attr('id');
                var location = $(this).data('location');
                console.log("#" + id_div);
                $.ajax({
                    type: "GET",
                    url: "hola/hola",
                    cache: false,
                    contentType: false,
                    processData: false,
                    beforeSend: function (xhr) {
                        $("#ajax_loader").show();
                    }
                }).done(function (data) {
                    $("#" + id_div).html(data.html);
                    console.log("#" + id_div);
                });


            });

        }
        function selectLocation(paises) {
            $('#where_id').select2({
                ajax: {
                    url: "{{ path('ajax_get_where') }}",
                    processResults: function (data) {
                        console.log(data);
                        return {results: data.items}
                    },
                    data: function (params) {
                        var query = {
                            q: params.term,
                            paises: paises,
                            campos: campos,
                            type: 'public'
                        }
                        return query;
                    }

                }
            });
        }

        function selectLocationOrg(org) {
            $('#where_id_org').select2({
                ajax: {
                    url: "{{ path('ajax_get_where_org') }}",
                    processResults: function (data) {
                        console.log(data);
                        return {results: data.items}
                    },
                    data: function (params) {
                        var query = {
                            q: params.term,
                            org: org,
                            project: "{{project.id}}",
                            campos: campos,
                            type: 'public'
                        }
                        return query;
                    }

                }
            });
        }

        function getOrgsFilters(idorg) {
            $("#list-filter-org").html('<i class="fa fa-spinner fa-spin fa-2x fa-fw"></i><span class="sr-only">Loading...</span>');
            $.ajax({
                type: "GET",
                url: "{{ path('get_orgs_filters') }}/" + "{{ project.id }}/" + "{{ project.lang }}",
                cache: false,
                contentType: false,
                processData: false
            }).done(function (data) { // console.log(data.total);
                $("#list-filter-org").html(data.html);
                $(".list-org").removeClass('list-org-active');
                $("#list-org" + idorg).addClass('list-org-active');
                $('[data-toggle="tooltip"]').tooltip();
            });
        }

        function getOrgsActs(id_org) {
            $("#box-main-org").html('<i class="fa fa-spinner fa-spin fa-2x fa-fw"></i><span class="sr-only">Loading...</span>');
            $.ajax({
                type: "GET",
                url: "{{ path('get_list_org') }}/" + "{{ project.id }}/" + "{{ project.lang }}/" + id_org + "/" + campos,
                cache: false,
                contentType: false,
                processData: false
            }).done(function (data) { // console.log(data.total);
                $("#box-main-org").html(data.html);
                selectLocation(paises);
                // electLocation(paises);
                //Tablesaw.init("#tbale2");

                // $(".tablesaw-bar").hide();
                // $("#tablesaw-bar").html($(".tablesaw-bar").html());
                // $("#tbale2").before("<div id='box-table'>");

                var ventana_altod = $(window).height() - 360;

                $('[data-toggle="tooltip"]').tooltip(); 
                var i = 0;
                if(data.total > 10){
                    table = $("#tbale2").DataTable({paging: false, searching: true, "pageLength": 5000, "scrollY": "55vh", "scrollX": true,
                   });
                }else{
                    table = $("#tbale2").DataTable({paging: false, searching: true, "pageLength": 5000, "scrollY": true, "scrollX": true });
                }

                table.order([1, 'asc']).draw();

                $("#tbale2 thead th").each( function ( i ) {
                    
                    if($(this).attr('id') == "sectorth" || $(this).attr('id') == "estadoth" || $(this).attr('id') == "departamentoth" || $(this).attr('id') == "municipioth" || $(this).attr('id') == "actividadth" ){ 
                        var select = $('#'+$(this).data('name'))
                        .on( 'change', function () {
                            table.column( i )
                                .search( $(this).val() )
                                .draw();
                        } );
                    select.append("<option value=''>All</option>");
                    table.column( i ).data().unique().sort().each( function ( d, j ) {
                        select.append( '<option value="'+d+'">'+d+'</option>' )
                    } );
                    }
                });

                $("#dropdown1, #dropdown2, #dropdown3, #dropdown4, #dropdown5").select2();
              
            });
        }

        function makeSelectFromColumn(columna,dropdown) {
            var arr = [];
            $("."+columna).each(function() {
                console.log("----"+$.trim($(this).text())+"----");
                if ($.inArray($.trim($(this).text()), arr) == -1)
                    arr.push($.trim($(this).text()));
            });
            console.log(arr);
            var select = $("#"+dropdown);
            for (var i = 0; i < arr.length; i++) {
                $("<option value='"+arr[i]+"' >" + arr[i] + "</option>").appendTo(select);
            }
        }

        function Selectactivity(sector) {

            $('#actividad_id').select2({
                ajax: {
                    url: "{{ path('ajax_get_activities') }}",
                    processResults: function (data) {
                        return {results: data.items};
                    },
                    data: function (params) {
                        var query = {
                            q: params.term,
                            lang: "{{ project.lang }}",
                            ssector: sector,
                            tipo: "{{ 'subsector_id' in campos ? 'ssector':'sector' }}",
                            project: "{{ project.id }}",
                            type: 'public'
                        }
                        return query;
                    }
                }
            });
        }

        function SelectOrg() {
            $('#financed').select2({
                ajax: {
                    url: "{{ path('ajax_get_orgs') }}",
                    processResults: function (data) {
                        console.log(data);
                        return {results: data.items};
                    },
                    data: function (params) {
                        var query = {
                            q: params.term,
                            lang: "{{ project.lang }}",
                            type: 'public'
                        }
                        return query;
                    }
                }
            });
        }
        function enviaForm() {
            var text = $("#btn-add-record").html();
            $("#btn-add-record").html("<i id='load-spiner' class='fa fa-spinner fa-spin fa-fw'></i> Saving ...");

            var form = $("#form-record");
            var valida = 0;

            $.ajax({
                type: "POST", url: "{{ path('admin_www_new') }}", data: form.serialize(), // serializes the form's elements.
                success: function (data) {

                    var record = data.item;
                    
                    console.log();
                    if (data.edita == 1) {
                        $("#modal-form-record").modal('hide');
                        $("#tr-record-"+data.idw).html(data.html);

                    } else {
                        $("#table-modal").prepend("<tr>"+data.html+"<tr>");
                        $("#tableact"+data.actid).prepend("<tr>"+data.html+"<tr>");
                        $(".savingact").hide();
                        
  
                    }
                    $("#btn-add-record").html(text);
                    //getOrgsActs(data.idorg);

                }
            });

            return false;
        }
    </script>
{% endblock %}
